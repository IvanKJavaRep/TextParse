= Описание API BPM
:revnumber: 2.0
:version-label: Версия
:title-page:
//:title-page-background-image: titlepage.png
:toc-title: Содержание
:toclevels: 7
:sectnumlevels: 7
:toc:

:toc-class: docx
:toc-max-pagenum-digits: 7
:figure-caption: Рисунок
:source-highlighter: rouge
:table-caption!:
:important-caption: Важно
:note-caption: Обратите внимание
:noheader:
:data-uri:
:chapter-label:
:doctype: book


<<<

<<<


:sectnums!:


== История изменений

[cols="30,15,55", options="header",]
|===
|Дата |Версия документа |Изменения

|26.11.2021 |{revnumber} |

Актуализированы методы «<<Метод авторизации и получения авторизующей cookie>>», «<<Метод получения информации по обращению>>», «<<Метод создания обращения>>», «<<Метод добавления вложения в обращение>>», «<<Метод добавления комментария к обращению>>», «<<Метод возврата обращения в работу или его закрытия>>»; +
Добавлен новый метод «<<Метод по получению информации по массиву обращений с условием>>»

|08.02.2020 |1.0 |Начальная версия
|===


<<<

<<<


== Перечень терминов и сокращений

[cols="50,50", options="header",]
|===
|Термин, сокращение |Определение

|API BPM |Интерфейс взаимодействия Системы обработки обращений Службы технической поддержки Оператора

|ИНН |Идентификационный номер налогоплательщика

|СТП |Служба технической поддержки
|===


<<<

<<<


:sectnums:


== Назначение и условия применения API BPM


=== Общие положения

Интерфейс взаимодействия Системы обработки обращений СТП Оператора (API BPM) предназначен для интеграции Систем (ServiceDesk, товарно-учетные системы и пр.) Участника с системой обработки обращений Оператора.

С помощью API BPM можно:

* направить обращение в СТП;
* получить информацию по обращению;
* внести дополнительную информацию по обращению;
* вернуть обращение в работу или закрыть его.

Время доступности API BPM 24 часа, 7 дней в неделю с перерывами на техническое обслуживание.

По вопросам работы API BPM необходимо обращаться в СТП Оператора по телефону 8-800-222-15-23 или по электронной почте support@crpt.ru.


=== Доступ к API BPM

Доступ к API BPM предоставляется Участникам, зарегистрированным на Портале технической поддержки - https://support.crpt.ru[support.crpt.ru]. Тестовый стенд доступен по адресу https://int.support.crpt.ru/[int.support.crpt.ru].

Для регистрации на Портале технической поддержки необходимо создать обращение в СТП Оператора на электронный почтовый адрес: support@crpt.ru. В обращении необходимо указать:

* наименование Пользователя;
* ИНН;
* контактные данные представителей, уполномоченных осуществлять взаимодействие с СТП:
** Ф.И.О.;
** должность;
** номер телефона;
** адрес электронной почты.


=== Информирование об изменениях

Изменения в API BPM публикуются на сайте https://честныйзнак.рф/[честныйзнак.рф], а также в информационной рассылке не позднее двух недель до внесения изменений.

Узнать об изменениях и ознакомиться с актуальной версией описания методов API BPM можно на сайте https://честныйзнак.рф/[честныйзнак.рф].


<<<

<<<


== Обращение к API


=== Метод авторизации и получения авторизующей cookie

Метод используется для авторизации на API и получения авторизующей cookie. После получения cookie её необходимо добавлять в headers каждого запроса.

*URL:* {hostname}/ServiceModel/AuthService.svc/Login

*Метод:* POST

*Пример строки запроса:*

[source]
----
curl -X POST "{hostname}/ServiceModel/AuthService.svc/Login"
----

*Пример запроса:*

 [source,json]
----
{
   "UserName":"string",
   "UserPassword":"string"
}
----

*Параметры запроса:*

[cols="15,10,10,20,45",options="header",]
|===
|Параметр |Тип |Обяз. |Описание| Комментарий

|login |string |+ |Логин |

|password |string |+ |Пароль |
|===

*Заголовки ответа:*

[source]
----
Set-Cookie: BPMLOADER=cookie_value; path=/Creatio_application_address; HttpOnly

Set-Cookie: .ASPXAUTH=cookie_value; path=/Creatio_application_address; HttpOnly

Set-Cookie: BPMCSRF=cookie_value; path=/

Set-Cookie: UserName=cookie_value; expires=date_expire_to; path=/; HttpOnly
----

Cookie BPMLOADER, .ASPXAUTH, BPMCSRF нужно добавлять в headers запросов.

*Пример ответа при успешном выполнении запроса:*

[source,json]
----
{
   "Code":200,
   "Message":"string",
   "Exception":null,
   "PasswordChangeUrl":null,
   "RedirectUrl":null
}
----

*Пример ответа при неуспешном выполнении запроса:*

[source,json]
----
{
   "Code":1,
   "Message":"Неправильное имя пользователя или пароль",
   "Exception":{
      "HelpLink":null,
      "InnerException":null,
      "Message":"Security error",
      "StackTrace":"",
      "Type":"System.Security.SecurityException"
   },
   "PasswordChangeUrl":null,
   "RedirectUrl":null
}
----


=== Метод получения информации по обращению

Метод возвращает следующую информацию по обращению:

* тема;
* описание;
* приоритет;
* состояние обращения;
* сообщения от специалистов СТП и ссылки на прикрепленные файлы;
* решение по обращению.

*URL:* {hostname}/0/ssp/rest/PublicWebServices/case/{номер обращения}

*Метод:* GET

*Пример строки запроса:*

[source]
----
curl -X GET "{hostname}/0/ssp/rest/PublicWebServices/case/SR00000000"
-H "Cookie:<cookie>"
----

*Пример ответа при успешном выполнении запроса:*

[source,json]
----
{
   "ok":true,
   "data":{
      "createdon":"22.07.2021 16:18:59",
      "files":[

      ],
      "id":null,
      "messages":[

      ],
      "modifiedon":null,
      "number":"SR00000000",
      "priority":4,
      "satisfactioncomment":"",
      "satisfactionlevel":0,
      "solution":"string",
      "status":"Закрыто",
      "statuscode":5,
      "statusdate":"25.07.2021 16:47:50",
      "subject":"string",
      "symptoms":"string"
   }
}
----

*Пример ответа при неуспешном выполнении запроса:*

[source,json]
----
{
   "error":"case not found"
}
----

*Параметры ответа:*

[cols="25,10,10,25,30",options="header",]
|===
|Параметр |Тип |Обяз. |Описание| Комментарий

|ok |boolean |+ |Результат выполнения запроса |

|data |array |+ |Идентификатор сообщения |

|*createdon |string |+ |Дата создания сообщения |

|*files |array |+ |Массив файлов для решения |

|*id |string |+ |Идентификатор сообщения |

|*messages |array |- |Текст сообщения |

|*modifiedon |string |- |Дата изменения обращения |

|*number |string |+ |Номер обращения |

|*priority |integer |+ |Приоритет a|Возможные значения:

* 1 - «Обычный»;
* 2 - «Средний»;
* 3 - «Высокий»;
* 4 - «Критический»

|*satisfactioncomment |string |+ |Комментарий к оценке |

|*satisfactionlevel |integer |+ |Уровень удовлетворенности (от 1 до 5) |

|*solution |string |+ |Решение |

|*status |string |+ |Статус обращения |Возможные значения статусов обращения см. в «<<Приложение 1. Справочник «Статусы обращений»>>»

|*statuscode |integer |+ |Код статуса  |Возможные значения кодов статуса см. в «<<Приложение 1. Справочник «Статусы обращений»>>»

|*statusdate |string |+ |Дата последнего статуса |

|*subject |string |+ |Тема обращения |

|*symptoms |string |+ |Описание проблемы, с которой обратился Участник |

|error |string |- |Описание ошибки | Появляется только при неуспешном выполнении запроса
|===


=== Метод создания обращения

Метод возвращает номер созданного обращения.

*URL:* {hostname}/0/ssp/rest/PublicWebServices/case

*Метод:* POST

*Пример строки запроса:*

[source]
----
curl -X POST "{hostname}/0/ssp/rest/PublicWebServices/case"
-H "Cookie:<cookie>"
----

*Пример запроса:*

[source,json]
----
{
   "subject":"Проблема с авторизацией",
   "symptoms":"Не выполняется авторизация с помощью УКЭП"
}
----

*Пример ответа при успешном выполнении запроса:*

[source,json]
----
{
   "ok":true,
   "data":"SR00000000"
}
----

*Пример ответа при неуспешном выполнении запроса:*

[source,json]
----
{
   "error":"case not found",
   "ok":false
}
----

*Параметры ответа:*

[cols="15,10,10,20,45",options="header",]
|===
|Параметр |Тип |Обяз. |Описание |Комментарий

|ok |boolean |+ |Результат выполнения запроса |

|data |string |+ |Номер обращения |

|error |string |- |Описание ошибки | Появляется только при неуспешном выполнении запроса
|===


=== Метод добавления вложения в обращение

Метод предназначен для добавления вложения в обращение (скриншоты, файлы и т.д.).

*URL:* {hostname}/0/ssp/rest/PublicWebServices/file

*Метод:* POST

*Пример строки запроса:*

[source]
----
curl -X POST "{hostname}/0/ssp/rest/PublicWebServices/file?filename=case.xlsx&number=SR00000000&totallength=35000"
-H "Cookie:<cookie>"
----

*Параметры запроса:*

[cols="15,10,10,20,45",options="header",]
|===
|Параметр |Тип |Обяз. |Описание |Комментарий

|filename |string |+ |Название файла |

|number |string |+ |Номер обращения |

|totallength |integer |+ |Размер файла |
|===

*Пример ответа при успешном выполнении запроса:*

[source,json]
----
{
   "ok":true
}
----

*Пример ответа при неуспешном выполнении запроса:*

[source]
----
"File not found"
----

*Параметры ответа:*

[cols="20,10,10,20,40",options="header",]
|===
|Параметр |Тип |Обяз. |Описание |Комментарий

|ok |boolean |- |Результат выполнения запроса |

|error_message |string|- |Сообщение об ошибке a|Возможные значения:

* «File not found» (Файл не найден);
* «Exceeded the maximum number of request per minute» (Превышено максимальное количество запросов в минуту)
|===


=== Метод добавления комментария к обращению

Метод позволяет добавить новый комментарий к обращению от оператора СТП.

*URL:* {hostname}/0/ssp/rest/PublicWebServices/message

*Метод:* POST

*Пример строки запроса:*

[source]
----
curl -X POST "{hostname}/0/ssp/rest/PublicWebServices/message"
-H "Cookie:<cookie>"
----

*Пример запроса:*

[source,json]
----
{
   "number":"SR00000000",
   "text":"Проблема решена"
}
----

*Параметры запроса:*

[cols="15,10,10,20,45",options="header",]
|===
|Параметр |Тип |Обяз. |Описание |Комментарий

|number |string |+ |Номер обращения |

|text |string |+ |Текст сообщения |
|===

*Пример ответа при успешном выполнении запроса:*

[source,json]
----
{
   "ok":true,
   "data":"string"
}
----

*Пример ответа при неуспешном выполнении запроса:*

[source,json]
----
{
   "error":"number data is required",
   "ok":false
}
----

*Параметры ответа:*

[cols="15,10,10,20,45",options="header",]
|===
|Параметр |Тип |Обяз. |Описание |Комментарий

|ok |boolean |+ |Результат выполнения запроса |

|data |string |+ |Идентификатор сообщения |

|error |string |- |Описание ошибки | Появляется только при неуспешном выполнении запроса
|===


=== Метод возврата обращения в работу или его закрытия

Метод позволяет вернуть обращение в работу или закрыть его.

*URL:* {hostname}/0/ssp/rest/PublicWebServices/update_case

*Метод:* POST

*Пример строки запроса:*

[source]
----
curl -X POST "{hostname}/0/ssp/rest/PublicWebServices/update_case"
-H "Cookie:<cookie>"
----

*Пример запроса:*

[source,json]
----
{
   "number":"SR00000000",
   "status":"close",
   "statuscode":"5",
   "satisfactionlevel":"3",
   "satisfactioncomment":"string",
   "statusdate":"13.06.2021 11:59:06"
}
----

*Параметры запроса:*

[cols="25,10,10,25,30",options="header",]
|===
|Параметр |Тип |Обяз. |Описание |Комментарий

|number |string |+ |Номер обращения |

|status |string |+ |Статус обращения a|Возможные значения:

* «close» («Закрыто») - обращение закрыто;
* «reopen» («Переоткрыто») - обращение переоткрыто. Доступно для обращения в статусе «Требует вашего внимания» с заполненным обязательным полем «solution» («Решение»)

|satisfactionlevel |integer |- |Уровень удовлетворенности решением обращения |Доступен для статуса «Требует вашего внимания» с заполненным обязательным полем «solution» («Решение»)

|satisfactioncomment |string |- |Комментарий к оценке решения |Доступен для статуса «Требует вашего внимания» с заполненным обязательным полем «solution» («Решение»)

|statuscode |integer |- |Код статуса |Возможные значения кодов статуса см. в «<<Приложение 1. Справочник «Статусы обращений»>>»

|statusdate |string |- |Дата последнего статуса |
|===

*Пример ответа при успешном выполнении запроса:*

[source,json]
----
{
   "ok":true,
   "data":"SR00000000"
}
----

*Пример ответа при неуспешном выполнении запроса:*

[source,json]
----
{
   "error":"number data is required",
   "ok":false
}
----

*Параметры ответа:*

[cols="15,10,10,20,45",options="header",]
|===
|Параметр |Тип |Обяз. |Описание |Комментарий

|data |string |+ |Номер обращения |

|error |string |- |Описание ошибки | Появляется только при неуспешном выполнении запроса
|===


=== Метод по получению информации по массиву обращений с условием

*URL:* {hostname}/0/ssp/rest/PublicWebServices/cases

*Метод:* POST

*Пример строки запроса:*

[source]
----
curl -X POST "{hostname}/0/ssp/rest/PublicWebServices/cases"
-H "Cookie:<cookie>"
----

*Пример запроса:*

[source,json]
----
{
   "numbers":["SR00000000"],
   "statuscode": [1, 2],
   "count":"2",
   "skip":"0",
   "from":"06.04.2021 11:17:05",
   "to":"06.04.2021 11:17:21",
   "search_line":"string",
   "availability_level":"1",
   "sort":["modifiedon", "statuscode"]
}
----

*Параметры запроса:*

[cols="20,10,10,25,35",options="header",]
|===
|Параметр |Тип |Обяз. |Описание |Комментарий

|numbers |string |- |Фильтр по номерам обращений |Массив с одним значением может указываться без квадратных скобок

|statuscode |integer |- |Фильтр по кодам статусов |Возможные значения кодов статуса см. в «<<Приложение 1. Справочник «Статусы обращений»>>»

|count |integer |- |Количество возвращаемых объектов |

|skip |string |- |Количество игнорируемых объектов от первоначальной выборки |

|from |string |- |Начало периода для фильтра по полю «createdon» («Дата создания сообщения») |

|to |string |- |Конец периода для фильтра по полю «createdon» («Дата создания сообщения») |

|search_line |string |- |Строка для поиска в теме и описании |

|availability_level |string |- |Выбор обращений a|Возможные значения:

* 0 - возвращает только созданные пользователем;
* 1 - возвращает все доступные

|sort |string |- |Сортировка a|Возможные значения:

* statuscode - первичная сортировка по статусам;
* modifiedon - сортировка по дате изменения
|===

Примечание: в запросе должен быть обязательно заполнен один из параметров.

*Пример ответа:*
[source,json]
----
{
   "ok":true,
   "count":1,
   "data":[
      {
         "createdon":"06.04.2021 11:17:21",
         "files":[

         ],
         "id":"00000001",
         "messages":[
            {
               "contact":"string",
               "createdon":"06.04.2021 11:17:24",
               "files":[

               ],
               "id":"00000002",
               "text":"string",
               "type":null
            },
            {
               "contact":"string",
               "createdon":"07.04.2021 14:45:18",
               "files":[

               ],
               "id":"00000003",
               "text":"string",
               "type":null
            },
            {
               "contact":"string",
               "createdon":"07.04.2021 14:45:24",
               "files":[

               ],
               "id":"00000004",
               "text":"string",
               "type":null
            }
         ],
         "modifiedon":"07.04.2021 14:45:18",
         "number":"SR0000000",
         "priority":4,
         "satisfactioncomment":"",
         "satisfactionlevel":0,
         "solution":"string",
         "status":"Предоставлено решение",
         "statuscode":2,
         "statusdate":"07.04.2021 14:45:13",
         "subject":"string",
         "symptoms":"string"
      }
   ],
   "pagecount":1
}
----

*Параметры ответа:*

[cols="25,10,10,25,30",options="header",]
|===
|Параметр |Тип |Обяз. |Описание |Комментарий

|ok |boolean |+ |Результат выполнения запроса |

|count |integer |- |Количество возвращаемых объектов |

|data |string |- |Идентификатор обращения |

|*createdon |string |- |Дата создания обращения |

|*files |array |- |Массив файлов для решения |

|*id |string |- |Идентификатор обращения |

|*messages |string |- |Массив данных переписки |

|*modifiedon |string |- |Дата изменения обращения |

|*number |string |- |Номер обращения |

|*priority |integer |- |Приоритет a|Возможные значения:

* 1 - «Обычный»;
* 2 - «Средний»;
* 3 - «Высокий»;
* 4 - «Критический»

|*satisfactioncomment  |string |- |Комментарий к оценке |

|*satisfactionlevel |integer |- |Уровень удовлетворенности (от 1 до 5) |

|*solution |string |- |Решение |

|*status |string |- |Статус обращения |Возможные значения статусов обращения см. в «<<Приложение 1. Справочник «Статусы обращений»>>»

|*statuscode |integer |- |Код статуса |Возможные значения кодов статуса см. в «<<Приложение 1. Справочник «Статусы обращений»>>»

|*statusdate |string |- |Дата последнего статуса |

|*subject |string |- |Тема обращения |

|*symptoms |string |- |Описание проблемы, с которой обратился Участник |

|pagecount |integer |- |Количество обращений |
|===


<<<

<<<


:sectnums!:


== Приложение 1. Справочник «Статусы обращений»

[cols="35,65",options="header",]
|===
|Код статуса («statuscode») |Статус обращения («status»)

|1 |Требует Вашего внимания

|2 |Предоставлено решение

|3 |В работе

|4 |Открыто

|5 |Закрыто / close

|6 |Переоткрыто / reopen
|===